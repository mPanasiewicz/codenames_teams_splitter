<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code Names Team Splitter</title>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .team {
        margin-top: 20px;
      }
      .team h2 {
        color: white;
        padding: 10px;
      }
      .red-team {
        background-color: red;
      }
      .blue-team {
        background-color: blue;
      }
      .remove-button {
        margin-right: 10px;
      }
      .spymaster {
        font-weight: bold;
        color: gold;
      }
      .split-teams-button {
        width: 100%;
        background-color: #28a745;
        color: white;
      }
    </style>
  </head>
  <body class="container">
    <h1 class="my-4">Code Names Team Splitter</h1>
    <div class="input-group mb-3">
      <input
        type="text"
        id="nameInput"
        class="form-control"
        placeholder="Enter name"
      />
      <div class="input-group-append">
        <button class="btn btn-primary" onclick="addName()">Add Name</button>
      </div>
    </div>
    <ul id="nameList" class="list-group mb-3"></ul>
    <button class="btn split-teams-button mb-3" onclick="splitTeams()">
      Split Teams
    </button>
    <div class="mb-3">
      <button class="btn btn-success mr-2" onclick="saveSpymasters()">
        Save Spymasters
      </button>
      <button class="btn btn-warning" onclick="clearSpymasters()">
        Clear Saved Spymasters
      </button>
    </div>
    <div class="team red-team p-3">
      <h2>Red Team</h2>
      <ul id="redTeam" class="list-group"></ul>
    </div>
    <div class="team blue-team p-3 mt-3">
      <h2>Blue Team</h2>
      <ul id="blueTeam" class="list-group"></ul>
    </div>

    <div class="mt-4">
      <h3>Last 10 Saved Spymasters</h3>
      <div id="spymastersHistory" class="list-group">
        <p class="text-muted">Loading history...</p>
      </div>
    </div>

    <script>
      const API_URL = 'http://localhost:3000/api';
      let names = [
        "Beth",
        "Melissa",
        "Ava",
        "Pawe≈Ç",
        "Steve",
        "Piotr",
        "Lucas",
        "Maciej",
        "Shalini",
        "Orlane",
      ];
      let currentRedSpymaster = null;
      let currentBlueSpymaster = null;

      async function loadSavedSpymasters() {
        try {
          const response = await fetch(`${API_URL}/spymasters`);
          const data = await response.json();
          if (data.redSpymaster && data.blueSpymaster) {
            currentRedSpymaster = data.redSpymaster;
            currentBlueSpymaster = data.blueSpymaster;
            console.log('Loaded saved spymasters:', data);
          }
        } catch (error) {
          console.error('Error loading spymasters:', error);
        }
      }

      async function saveSpymasters() {
        if (!currentRedSpymaster || !currentBlueSpymaster) {
          alert('Please split teams first to save spymasters.');
          return;
        }

        try {
          const response = await fetch(`${API_URL}/spymasters`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              redSpymaster: currentRedSpymaster,
              blueSpymaster: currentBlueSpymaster,
            }),
          });
          const data = await response.json();
          alert('Spymasters saved successfully!');
          await loadSpymastersHistory();
        } catch (error) {
          console.error('Error saving spymasters:', error);
          alert('Failed to save spymasters.');
        }
      }

      async function clearSpymasters() {
        try {
          const response = await fetch(`${API_URL}/spymasters`, {
            method: 'DELETE',
          });
          const data = await response.json();
          currentRedSpymaster = null;
          currentBlueSpymaster = null;
          alert('Saved spymasters cleared successfully!');
          await loadSpymastersHistory();
        } catch (error) {
          console.error('Error clearing spymasters:', error);
          alert('Failed to clear spymasters.');
        }
      }

      async function loadSpymastersHistory() {
        try {
          const response = await fetch(`${API_URL}/spymasters/history`);
          const data = await response.json();
          const historyDiv = document.getElementById('spymastersHistory');
          
          if (!data.history || data.history.length === 0) {
            historyDiv.innerHTML = '<p class="text-muted">No saved spymasters yet.</p>';
            return;
          }

          historyDiv.innerHTML = '';
          data.history.forEach((entry) => {
            const item = document.createElement('div');
            item.className = 'list-group-item';
            const date = new Date(entry.createdAt).toLocaleString();
            item.innerHTML = `
              <strong>Red:</strong> ${entry.redSpymaster} | 
              <strong>Blue:</strong> ${entry.blueSpymaster} 
              <span class="text-muted">(${date})</span>
            `;
            historyDiv.appendChild(item);
          });
        } catch (error) {
          console.error('Error loading history:', error);
          const historyDiv = document.getElementById('spymastersHistory');
          historyDiv.innerHTML = '<p class="text-danger">Failed to load history.</p>';
        }
      }

      function initializeNames() {
        const nameList = document.getElementById("nameList");
        names.forEach((name) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          li.textContent = name;
          li.appendChild(createRemoveButton(name));
          nameList.appendChild(li);
        });
      }

      function addName() {
        const nameInput = document.getElementById("nameInput");
        const name = nameInput.value.trim();
        if (name) {
          names.push(name);
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          li.textContent = name;
          li.appendChild(createRemoveButton(name));
          document.getElementById("nameList").appendChild(li);
          nameInput.value = "";
        }
      }

      function createRemoveButton(name) {
        const button = document.createElement("button");
        button.className = "btn btn-danger btn-sm remove-button";
        button.textContent = "-";
        button.onclick = () => removeName(name);
        return button;
      }

      function removeName(name) {
        names = names.filter((n) => n !== name);
        const nameList = document.getElementById("nameList");
        const items = nameList.getElementsByTagName("li");
        for (let i = 0; i < items.length; i++) {
          if (items[i].textContent.includes(name)) {
            nameList.removeChild(items[i]);
            break;
          }
        }
      }

      function splitTeams() {
        if (names.length < 4) {
          alert("Please add at least 4 names.");
          return;
        }

        let availableNames = [...names];
        let redTeam = [];
        let blueTeam = [];

        if (currentRedSpymaster && availableNames.includes(currentRedSpymaster)) {
          redTeam.push(currentRedSpymaster);
          availableNames = availableNames.filter(n => n !== currentRedSpymaster);
        }

        if (currentBlueSpymaster && availableNames.includes(currentBlueSpymaster)) {
          blueTeam.push(currentBlueSpymaster);
          availableNames = availableNames.filter(n => n !== currentBlueSpymaster);
        }

        const shuffledNames = availableNames.sort(() => 0.5 - Math.random());
        const totalPerTeam = Math.ceil(names.length / 2);
        const redNeeded = totalPerTeam - redTeam.length;
        const blueNeeded = totalPerTeam - blueTeam.length;

        redTeam.push(...shuffledNames.slice(0, redNeeded));
        blueTeam.push(...shuffledNames.slice(redNeeded, redNeeded + blueNeeded));

        if (!currentRedSpymaster) {
          currentRedSpymaster = redTeam[0];
        }
        if (!currentBlueSpymaster) {
          currentBlueSpymaster = blueTeam[0];
        }

        displayTeam("redTeam", redTeam);
        displayTeam("blueTeam", blueTeam);
      }

      function displayTeam(teamId, team) {
        const teamElement = document.getElementById(teamId);
        teamElement.innerHTML = "";
        team.forEach((name, index) => {
          const li = document.createElement("li");
          li.className = "list-group-item";
          if (index === 0) {
            li.classList.add("spymaster");
            li.innerHTML = `üïµÔ∏è‚Äç‚ôÇÔ∏è ${name} - Spymaster`;
          } else {
            li.textContent = `${name} - Operative`;
          }
          teamElement.appendChild(li);
        });
      }

      window.onload = async () => {
        await loadSavedSpymasters();
        await loadSpymastersHistory();
        initializeNames();
      };
    </script>
  </body>
</html>
